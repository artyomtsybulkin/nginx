x-common-options: &common-options
  mem_limit: 1g
  cpus: 2.0
  pids_limit: 100
  cap_drop: [ ALL ]
  cap_add: [ NET_BIND_SERVICE ]
  tmpfs: [ /tmp ]
  logging: { driver: journald }
  security_opt: [ no-new-privileges:true ]
  restart: unless-stopped
  stop_grace_period: 30s
x-common-healthcheck: &common-healthcheck
  interval: 60s
  timeout: 15s
  retries: 3

networks:
  public_net:  { external: true }
  private_net: { external: true }

services:
  nginx:
    container_name: nginx
    image: docker.io/ubuntu/nginx:latest
    healthcheck:
      test: ["CMD-SHELL", "pidof nginx || exit 1"]
      <<: *common-healthcheck
    <<: *common-options
    networks: [ private_net, public_net ]
    ports: [ "80:80", "443:443" ]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl-params.conf:/etc/nginx/snippets/ssl-params.conf:ro
      - ./letsencrypt:/etc/letsencrypt:ro
      - ./logs:/var/log/nginx:Z
    environment: [ TZ: "${TZ}" ]

  certbot:
    image: docker.io/certbot/dns-cloudflare:latest
    container_name: certbot
    restart: unless-stopped
    volumes:
      - ./letsencrypt:/etc/letsencrypt:Z
      - ./cloudflare.ini:/cloudflare.ini:ro
    entrypoint: /bin/sh
    command: >
      -c "trap exit TERM; while :; do
      certbot renew --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini --quiet;
      sleep 12h & wait $!;
      done"
